# Format String Bug

## Format String Bug
- **Format String Bug(FSB)** : 포맷 스트링 함수를 잘못 사용하여 발생하는 버그
  - 포맷 스트링을 사용자가 직접 입력할 수 있으면 공격자는 레지스터와 스택을 읽을 수 있고 임의 주소 읽기 및 쓰기도 가능함 
- **Format String** : `%[parameter][flags][width][.precision][length][specifier]`
  - specifier : 인자를 어떻게 사용할지 지정함
    | 형식 지정자 | 설명 |
    |------------|------|
    | d | 부호 있는 10진수 정수 |
    | u | 부호 없는 10진수 정수 |
    | s | 문자열 |
    | x | 부호 없는 16진수 정수 |
    | n | 해당하는 위치의 인자에 현재까지 사용된 문자열의 길이를 저장 (값 출력 X) |
    | p | void형 포인터 |
  - width : 최소 너비를 지정함
    | 너비 지정자 | 설명 |
    |------------|------|
    | 정수 | 정수의 값만큼을 최소 너비로 지정합니다. |
    | * | 인자를 두 개 사용 <br>첫 인자의 값만큼을 최소 너비로 지정해 두 번째 인자를 출력 |
    - 치환되는 문자열이 이 값보다 짧을 경우, 공백 문자(`' '`)를 문자열 앞에 패딩해줌  
  - length : 출력하고자 하는 변수의 크기를 지정함
    | 길이 지정자 | 설명 |
    |------------|------|
    | hh | 해당 인자가 `char` 크기임을 나타냄 |
    | h | 해당 인자가 `short int` 크기임을 나타냄 |
    | l | 해당 인자가 `long int` 크기임을 나타냄 |
    | ll | 해당 인자가 `long long int` 크기임을 나타냄 |
    - d, n 등의 형식 지정자 앞에 쓰임
    - 정수 값을 출력하고 싶지만 변수가 int형이 아닌 경우에 주로 사용함
    - ex. char형을 정수 형태로 출력 : `%hhd`
  - parameter : 참조할 인자의 인덱스를 지정함 
    - `%[파라미터값]$d`처럼 값 뒤에 `$`문자를 붙여 표기
    - 특정 인덱스의 인자를 사용할 수 있음
    - 파라미터 값이 전달된 인자의 갯수의 범위 내인지 확인하지 않음

### FSB - Read 
- 레지스터 및 스택 읽기
  ```
  int main() {
  char format[0x100];
  
  printf("Format: ");
  scanf("%s", format);
  printf(format);
  
  return 0;
  }
  ```
  - format = `%p, %p, %p, %p, %p, %p, %p, %p`인 경우
    - 함수 호출 규약에 따라 rdi의 다음 인자인 **rsi, rdx, rcx, r8, r9, [rsp], [rsp+8], [rsp+0x10]** 이 출력됨
    - printf 함수는 인자 개수를 확인하지 않으므로, 실제로 인자가 넘어오지 않아도 호출 규약에 따라 인자를 참조함
      
- 임의 주소 읽기
  - 스택에 어떤 메모리의 주소값이 적혀있다면 ,해당 주소에 적혀있는 값을 파라미터 값을 활용해 읽어올 수 있음
  - 예시 : 읽어오고 싶은 값(문자열)이 `rsp + 8`위치에 저장되어 있으면?
    - 호출 규약에 따라, `%7$s`를 사용하면 출력할 수 있음

### FSB - Write
- 임의 주소 쓰기
  - 포맷 스트링에 임의의 주소를 넣고, `%[n]$n`의 형식 지정자를 사용하면 그 주소에 데이터를 쓸 수 있음 
